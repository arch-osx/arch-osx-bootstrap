# libarchive out of memory

==> Tidying install...
  -> Purging unwanted files...
  -> Stripping unneeded symbols from binaries and libraries...
  -> Compressing man and info pages...
==> Checking for packaging issue...
==> Creating package "libtool"...
  -> Generating .PKGINFO file...
  -> Generating .BUILDINFO file...
  -> Adding install file...
  -> Generating .MTREE file...
Fatal Internal Error in libarchive: Out of memory
  -> Compressing package...
==> Leaving fakeroot environment.
==> Finished making: libtool 2.4.6-1 (Sat  9 Apr 2016 10:53:25 CEST)

10/04/2016 11:44:40.829 bsdtar[74121]: bsdtar(74121,0x7fff7f264000) malloc: *** mach_vm_map(size=18446744073709543424) failed (error code=3)
*** error: can't allocate region
*** set a breakpoint in malloc_error_break to debug

# crash tmp

```
debug: pacman v5.0.1 - libalpm v10.0.1
debug: config: attempting to read file /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/etc/pacman.conf
debug: config: new section 'options'
debug: config: HoldPkg: pacman
debug: config: HoldPkg: glibc
debug: config: arch: x86_64
debug: config: finished parsing /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/etc/pacman.conf
debug: setup_libalpm called
debug: option 'logfile' = /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/var/log/pacman.log
debug: option 'gpgdir' = /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/etc/pacman.d/gnupg/
debug: option 'hookdir' = /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/etc/pacman.d/hooks/
debug: option 'cachedir' = /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/var/cache/pacman/pkg/
loading packages...
debug: "libtool-2.4.6-1-x86_64.pkg.tar.xz.sig" is not readable: No such file or directory
debug: opening archive libtool-2.4.6-1-x86_64.pkg.tar.xz
debug: starting package load for libtool-2.4.6-1-x86_64.pkg.tar.xz
debug: found mtree for package libtool-2.4.6-1-x86_64.pkg.tar.xz, getting file list
debug: finished mtree reading for libtool-2.4.6-1-x86_64.pkg.tar.xz
debug: sorting package filelist for libtool-2.4.6-1-x86_64.pkg.tar.xz
debug: adding package 'libtool'
debug: loading package cache for repository 'local'
debug: added 1 packages to package cache for db 'local'
debug: adding package libtool-2.4.6-1 to the transaction add list
resolving dependencies...
debug: resolving target's dependencies
debug: started resolving dependencies
debug: checkdeps: package libtool-2.4.6-1
debug: finished resolving dependencies
looking for conflicting packages...
debug: looking for conflicts
debug: check targets vs targets
debug: check targets vs targets
debug: check targets vs db and db vs targets
debug: check targets vs db
debug: check db vs targets
debug: checking dependencies
debug: checkdeps: package libtool-2.4.6-1
debug: returning error 32 from alpm_db_get_pkg : could not find or read package
debug: sorting by dependencies
debug: started sorting dependencies
debug: sorting dependencies finished
debug: returning error 32 from alpm_db_get_pkg : could not find or read package

Packages (1) libtool-2.4.6-1

Total Installed Size:  2.34 MiB

:: Proceed with installation? [Y/n] 
debug: using cachedir: /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/var/cache/pacman/pkg/
debug: using cachedir: /Users/lloeki/Workspace/projects/arch-osx-bootstrap/stage1/var/cache/pacman/pkg/
checking package integrity...
loading package files...
checking for file conflicts...
debug: looking for file conflicts
debug: searching for file conflicts: libtool
debug: searching for filesystem conflicts: libtool
debug: checking possible conflict: /usr/
debug: file is a directory, not a conflict
debug: checking possible conflict: /usr/local/
debug: file is a directory, not a conflict
debug: checking possible conflict: /usr/local/bin/
debug: file is a directory, not a conflict
debug: checking possible conflict: /usr/local/include/
debug: file is a directory, not a conflict
debug: checking possible conflict: /usr/local/lib/
debug: file is a directory, not a conflict
debug: checking possible conflict: /usr/local/share/
debug: file is a directory, not a conflict
debug: checking possible conflict: /usr/local/share/man/
debug: file is a directory, not a conflict
checking available disk space...
debug: checking available disk space
debug: discovered mountpoint: /net
debug: discovered mountpoint: /home
debug: discovered mountpoint: /dev
debug: discovered mountpoint: /Volumes/MobileBackups
debug: discovered mountpoint: /
debug: partition /, needed 598, cushion 5121, free 14326736
:: Processing package changes...
debug: installing packages
installing libtool...
debug: adding package libtool-2.4.6-1
```

message points to lib/libalpm/add.c, nothing looks interesing
exit code: http://tldp.org/LDP/abs/html/exitcodes.html

gdb? nope. lldb? maybe. Console.app!
http://lldb.llvm.org/lldb-gdb.html
Console.app! search for pacman, open crash report

```
Exception Type:        EXC_CRASH (SIGABRT)
Exception Codes:       0x0000000000000000, 0x0000000000000000
Exception Note:        EXC_CORPSE_NOTIFY

Application Specific Information:
detected buffer overflow

Thread 0 Crashed:: Dispatch queue: com.apple.main-thread
0   libsystem_kernel.dylib          0x00007fff97d01f06 __pthread_kill + 10
1   libsystem_pthread.dylib         0x00007fff9d9e84ec pthread_kill + 90
2   libsystem_c.dylib               0x00007fff9c9886e7 abort + 129
3   libsystem_c.dylib               0x00007fff9c98885e abort_report_np + 181
4   libsystem_c.dylib               0x00007fff9c9aea14 __chk_fail + 48
5   libsystem_c.dylib               0x00007fff9c9ae9e4 __chk_fail_overflow + 16
6   libsystem_c.dylib               0x00007fff9c9aec31 __strcpy_chk + 83
7   libalpm.10.dylib                0x000000010e63fc79 _alpm_runscriptlet + 313
8   libalpm.10.dylib                0x000000010e614ad0 commit_single_pkg + 656
9   libalpm.10.dylib                0x000000010e6147ce _alpm_upgrade_packages + 174
10  libalpm.10.dylib                0x000000010e63e4e1 _alpm_sync_commit + 177
11  libalpm.10.dylib                0x000000010e63f737 alpm_trans_commit + 871
12  pacman                          0x000000010e5f3af6 sync_prepare_execute + 854
13  pacman                          0x000000010e5f8762 pacman_upgrade + 994
14  pacman                          0x000000010e5eda0e main + 1822
15  libdyld.dylib                   0x00007fff900505ad start + 1
```
good, strcpy is not a dumb thing on this platform

points to run_scriptlet, so cross referencing call sites before delving in
aha, message was not as expected! '%s package %s'
now we have the good call site, know what args look like, can delve
ok now into run_scriptlet (trans.c):

```
int _alpm_runscriptlet(alpm_handle_t *handle, const char *filepath,
        const char *script, const char *ver, const char *oldver, int is_archive)
{
    char arg0[64], arg1[3], cmdline[PATH_MAX];
    char *argv[] = { arg0, arg1, cmdline, NULL };
    char *tmpdir, *scriptfn = NULL, *scriptpath;
    int retval = 0;
    size_t len;

    if(_alpm_access(handle, NULL, filepath, R_OK) != 0) {
        _alpm_log(handle, ALPM_LOG_DEBUG, "scriptlet '%s' not found\n", filepath);
        return 0;
    }

    if(!is_archive && !grep(filepath, script)) {
        /* script not found in scriptlet file; we can only short-circuit this early
         * if it is an actual scriptlet file and not an archive. */
        return 0;
    }

    strcpy(arg0, SCRIPTLET_SHELL);
    strcpy(arg1, "-c");
```

scriptlet gets run by bash in our bootstrap dir, very long path, blows past 64. increasing to PATH_MAX
=> success!

there should be some sanity check here though

# info/dir.gz

error: failed to commit transaction (conflicting files)
autoconf: /usr/local/share/info/dir.gz exists in filesystem
Errors occurred, no packages were upgraded.

./stage1/bin/pacman -Qo -b /usr/local/var/lib/pacman /usr/local/share/info/dir.gz
/usr/local/share/info/dir.gz is owned by libtool 2.4.6-1

makepkg.conf missing some default:

#-- Manual (man and info) directories to compress (if zipman is specified)¬
MAN_DIRS=({usr{,/local}{,/share},opt/*}/{man,info})¬
#-- Doc directories to remove (if !docs is specified)¬
DOC_DIRS=(usr/{,local/}{,share/}{doc,gtk-doc} opt/*/{doc,gtk-doc})¬
#-- Files to be removed from all packages (if purge is specified)¬
PURGE_TARGETS=(usr/{,share}/info/dir .packlist *.pod)¬

# sanity check

pacman -Ql | grep -v '/usr/local' | grep -v '^[^ ]* /usr/$'

# details

==> WARNING: Package contains reference to $srcdir
==> WARNING: Package contains reference to $pkgdir

==> WARNING: Cannot find library listed in 'provides': libarchive.so

# chroot of foo.install

/tmp/alpm_ynXgDS/.INSTALL: line 1: 10781 Killed: 9               /sbin/kextload /Library/Extensions/{tun,tap}.kext
20/04/2016 11:08:37.000 kernel[0]: AMFI: hook..execve() killing pid 10781: not allowed in chroot
